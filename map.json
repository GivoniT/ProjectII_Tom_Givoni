{
  "$schema": "https://vega.github.io/schema/vega/v5.json",
  "description": "Victorian schools coloured by Median VCE with SA2 average ICSEA backdrop.",
  "width": 900,
  "height": 650,
  "background": "#cfe5ff",
  "autosize": "none",
  "signals": [
    {
      "name": "zoom",
      "value": 11000
    }
  ],
  "data": [
    {
      "name": "sa2_base",
      "url": "data/geojson/output.json",
      "format": {
        "type": "topojson",
        "feature": "SA2_2016_AUST"
      },
      "transform": [
        {
          "type": "filter",
          "expr": "datum.properties && datum.properties.STE_NAME16 === 'Victoria'"
        }
      ]
    },
    {
      "name": "icsea",
      "url": "data/results_geo/vic_sa2_icsea_avg.csv",
      "format": {
        "type": "csv",
        "parse": {
          "SA2_MAIN16": "number",
          "icsea_mean": "number",
          "school_count": "number"
        }
      }
    },
    {
      "name": "sa2_joined",
      "source": "sa2_base",
      "transform": [
        {
          "type": "formula",
          "expr": "toNumber(datum.properties.SA2_MAIN16)",
          "as": "sa2_key"
        },
        {
          "type": "lookup",
          "from": "icsea",
          "key": "SA2_MAIN16",
          "fields": [
            "sa2_key"
          ],
          "values": [
            "icsea_mean",
            "sa2_name",
            "school_count"
          ]
        },
        {
          "type": "filter",
          "expr": "isValid(datum.icsea_mean)"
        }
      ]
    },
    {
      "name": "graticule",
      "url": "data/geojson/output.json",
      "format": {
        "type": "topojson",
        "feature": "ne_110m_graticules_1"
      }
    },
    {
      "name": "schools",
      "url": "data/results_geo/best_data.csv",
      "format": {
        "type": "csv",
        "parse": {
          "Latitude": "number",
          "Longitude": "number",
          "Median VCE study score": "number",
          "ICSEA": "number"
        }
      },
      "transform": [
        {
          "type": "filter",
          "expr": "datum.State === 'VIC'"
        },
        {
          "type": "filter",
          "expr": "isValid(datum.Latitude) && isValid(datum.Longitude) && isFinite(datum['Median VCE study score'])"
        },
        {
          "type": "formula",
          "expr": "datum.Latitude",
          "as": "lat"
        },
        {
          "type": "formula",
          "expr": "datum.Longitude",
          "as": "lon"
        },
        {
          "type": "formula",
          "expr": "datum['Median VCE study score']",
          "as": "vce_score"
        },
        {
          "type": "formula",
          "expr": "datum.ICSEA",
          "as": "icsea_value"
        }
      ]
    }
  ],
  "projections": [
    {
      "name": "proj",
      "type": "mercator",
      "center": [
        145.0,
        -37.5
      ],
      "scale": {
        "signal": "zoom"
      }
    }
  ],
  "scales": [
    {
      "name": "icseaColor",
      "type": "linear",
      "domain": {
        "data": "sa2_joined",
        "field": "icsea_mean"
      },
      "nice": true,
      "range": {
        "scheme": "yellowgreenblue"
      }
    },
    {
      "name": "vceColor",
      "type": "linear",
      "domain": {
        "data": "schools",
        "field": "vce_score"
      },
      "nice": true,
      "range": {
        "scheme": "plasma"
      }
    }
  ],
  "legends": [
    {
      "fill": "icseaColor",
      "title": [
        "Region Fill:",
        "Average ICSEA"
      ],
      "orient": "right"
    },
    {
      "fill": "vceColor",
      "title": [
        "School Point Colour:",
        "Median VCE Score"
      ],
      "orient": "right",
      "offset": 90
    }
  ],
  "marks": [
    {
      "type": "shape",
      "name": "sa2Background",
      "from": {
        "data": "sa2_base"
      },
      "transform": [
        {
          "type": "geoshape",
          "projection": "proj"
        }
      ],
      "encode": {
        "update": {
          "fill": {
            "value": "#f5e3c9"
          },
          "stroke": {
            "value": "#333333"
          },
          "strokeWidth": {
            "value": 0.5
          }
        }
      }
    },
    {
      "type": "shape",
      "name": "sa2Icsea",
      "from": {
        "data": "sa2_joined"
      },
      "transform": [
        {
          "type": "geoshape",
          "projection": "proj"
        }
      ],
      "encode": {
        "update": {
          "fill": {
            "scale": "icseaColor",
            "field": "icsea_mean"
          },
          "stroke": {
            "value": "#333333"
          },
          "strokeWidth": {
            "value": 0.8
          },
          "tooltip": {
            "signal": "{'Region Name': datum.sa2_name, 'Average ICSEA Score in the Region': format(datum.icsea_mean, '.0f'), 'Schools': datum.school_count}"
          }
        }
      }
    },
    {
      "type": "symbol",
      "name": "schoolsMarks",
      "zindex": 2,
      "from": {
        "data": "schools"
      },
      "transform": [
        {
          "type": "geopoint",
          "projection": "proj",
          "fields": [
            "lon",
            "lat"
          ],
          "as": [
            "x",
            "y"
          ]
        }
      ],
      "encode": {
        "update": {
          "x": {
            "field": "x"
          },
          "y": {
            "field": "y"
          },
          "size": {
            "value": 32
          },
          "fill": {
            "scale": "vceColor",
            "field": "vce_score"
          },
          "fillOpacity": {
            "value": 0.6
          },
          "stroke": {
            "value": "#ffffff"
          },
          "strokeWidth": {
            "value": 0.4
          },
          "tooltip": {
            "signal": "{'School': datum['School Name'], 'Suburb': datum.Suburb, 'Median VCE': format(datum.vce_score, '.1f'), 'ICSEA': format(datum.icsea_value, '.0f')}"
          }
        }
      }
    },
    {
      "type": "shape",
      "name": "graticuleLayer",
      "from": {
        "data": "graticule"
      },
      "transform": [
        {
          "type": "geoshape",
          "projection": "proj"
        }
      ],
      "encode": {
        "update": {
          "stroke": {
            "value": "#85a5c4"
          },
          "strokeWidth": {
            "value": 0.5
          },
          "fillOpacity": {
            "value": 0
          }
        }
      }
    }
  ],
  "config": {
    "style": {
      "guide-label": {
        "font": "Helvetica Neue"
      },
      "guide-title": {
        "font": "Helvetica Neue"
      }
    }
  }
}
